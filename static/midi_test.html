<html>
<head>
    <script type="text/javascript" src="./MidiConvert.js"></script>
    <script type="text/javascript" src="./record.js"></script>
    <script>
        var midiEvents = [
            {"data": [0x90, 0x30, 0x57]},
            {"data": [0x80, 0x30, 0x40]},
            {"data": [0x90, 0x3C, 0x57]},
            {"data": [0x90, 0x3C, 0x57]},
            {"data": [0x80, 0x3C, 0x40]}
        ];
        function run(){
            var stream = new KeyStream();
            var interval = 500;
            var play = function(index){
                setTimeout(function(){
                    stream.in(midiEvents[index])
                }, interval * index);
            };
            for(var i = 0; i < midiEvents.length; i++){
                play(i);
            }

            setTimeout(function(){
                var midi = stream.toTrack();
                console.log(midi);
                midiDownload(midi);
            }, interval * midiEvents.length);
        }
        function midiDownload(midi){
            console.log("download midi...");
            var a = document.createElement("a");
            a.download = "output.midi";
            a.target = "_blank";
            var bytechars = midi.encode();
            var byteNumbers = new Array(bytechars.length);
            for (var i = 0; i < bytechars.length; i++) {
                byteNumbers[i] = bytechars.charCodeAt(i);
            }
            var byteArray = new Uint8Array(byteNumbers);
            var blob = new Blob([byteArray], {type: 'application/x-pkcs12'})
            a.href = URL.createObjectURL(blob);
            a.click();
            console.log("done!");
        }

        run();
    </script>
</head>
<body>
    <h1>MIDI TEST!</h1>
</body>
</html>